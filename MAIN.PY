import time
import random
import asyncio
from google.oauth2.service_account import Credentials
import gspread
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Google Sheets API setup
scopes = ["https://www.googleapis.com/auth/spreadsheets"]
creds = Credentials.from_service_account_file("credentials.json", scopes=scopes)
client = gspread.authorize(creds)

sheet_id = "1dd2LSqZ9sJ7EAmCyvdAqDrwTksB8v8SSRZaKPlk58AE"
sheet = client.open_by_key(sheet_id).sheet1  

# Telegram Bot setup
TOKEN = '7603868482:AAEqa_1uDvQJam6grPs0d1T-X9KxeFWP3PY'
BOT_USERNAME = '@MD_BAU_bot'

# List of MD members
md_members = ["abdullah_almuflah", "Batool1412","ismael","sama","Menna","sora"]


def get_last_row():
    return len(sheet.col_values(2))

# Function to send message via Telegram bot
async def send_message(update: Update, context: ContextTypes.DEFAULT_TYPE, name: str, phone: str):
    try:
        first_name = name.split()[0]
        message1 = f"ูุนุทูู ุงูุนุงููู {first_name} ุงูุง ูู IEEE computer society ูุงูุช ูุณุฌู ุจููุฑู ุงูุงูุถูุงู ูุณุง ุญุงุจ ุชุณุฌู ูุนูุง ุ"
        message2 = f"the WhatsApp link: https://wa.me/962{phone}"
        message3 = "@" + random.choice(md_members)

        await update.message.reply_text(message1)
        await update.message.reply_text(message2)
        await update.message.reply_text(message3)
    except Exception as e:
        print(f"Error sending message: {e}")

# Function to check for new entries and send messages
async def check_new_entries(update: Update, context: ContextTypes.DEFAULT_TYPE):
    last_processed_row = get_last_row()
    while True:
        try:
            current_last_row = get_last_row()
            if current_last_row > last_processed_row:
                name = sheet.acell(f"B{current_last_row}").value
                phone = sheet.acell(f"D{current_last_row}").value
                sheet.format(f"B{current_last_row}", {
    "backgroundColor": {
        "red": 0.0,
        "green": 0.7,  # Green color
        "blue": 0.0
    },
    "horizontalAlignment": "CENTER",
    "textFormat": {
        "foregroundColor": {
            "red": 1.0,
            "green": 1.0,
            "blue": 1.0
        },
        "fontSize": 10,
        "bold": False
    }
})
                if name and phone:  # Ensure name and phone are not empty
                    await send_message(update, context, name, phone)
                    last_processed_row = current_last_row
            await asyncio.sleep(60)  # Check every 60 seconds
        except Exception as e:
            print(f"Error checking new entries: {e}")
            await asyncio.sleep(60)


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Bot started. Checking for new entries...")
    await update.message.reply_text("๐ค")
    asyncio.create_task(check_new_entries(update, context))  # Run in background


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("My job is to help the MD members.")


def handle_response(text: str) -> str:
    processed: str = text.lower()

    #-------------------------------------------------------

    if 'abdallah' in processed:
     return "@abdullah_almuflah"

    if 'batool' in processed:
     return "@Batool1412"

    if 'ุชุนุฑูู ุนู ุงูุจูุช' in processed:
     return "https://drive.google.com/file/d/12fyv-BI6e9ejQOEE1voJ3BsEucMxi6TN/view?usp=sharing"
    

    if 'ููุฏูููุงุช'  in processed:
        return '''https://drive.google.com/file/d/1w0ogt6Lj1SXCbP6bwTw3Q9ZQ8IQnXLA5/view?usp=drive_link
        
        https://drive.google.com/file/d/1sgkpz1m-PsX_mna_Dmx2zV3SNxxoNJhl/view?usp=drive_link
        '''
    if 'ููุฑู ุงูุงูุถูุงู'  in processed:
        return "https://docs.google.com/forms/d/e/1FAIpQLSfCcMvjHDOf5FLLH1TZLRqjzSyL2rVfmv14qnYGaHHJVqgOeg/viewform"

    if 'ูุง ูู ุงูcs' in processed:
        return '''IEEE ูู ููุธูุฉ ุนุงูููุฉ ูุชุฎุตุตุฉ ูุฏุนู ุงููููุฏุณูู ููุงูุฉ ุงููุฑูุน ุงูุชูููููุฌูุฉ. ุจุชููุณู ูุนุฏุฉ  ุฃูุณุงูุ ูููุง ุงููุณู ุงูุฃุณุงุณู ุงูููุฌูุฏ ูู ุงูุฌุงูุนุฉ ุ ูููู ููุงู  ุฃูุณุงู ูุฑุนูุฉ ูุซู
IEEE Computer Societyุ ุงููู ุจุชุฏุนู ุงูุทูุงุจ ูู ูุฌุงูุงุช ุงูุญุงุณูุจุ ุชูููููุฌูุง ุงููุนูููุงุชุ ุงูุฃูู ุงูุณูุจุฑุงููุ ูุงูุฐูุงุก ุงูุงุตุทูุงุนู. 

ูู ูุณู ูู IEEE ุจูุนูู ูุนุงููุงุช ุญุณุจ ุงูุชูุงูุงุชู ูุชูุฌูุงุชูุ ูุฃูุช ุจุชุฎุชุงุฑ ุงููุณู ุญุณุจ ุชุฎุตุตู ูุงูุชูุงูุงุชู. ูุณุง ุงุญูุง ูุณู IEEE Computer Society ุจููุฏูู ูุฑุดุงุช ูุฏูุฑุงุช ุชุฏุฑูุจูุฉ ููุณุงุจูุงุช ูุชุนููุฉ ุจุงูููุฏููุบุ ุงูุฃูู ุงูุณูุจุฑุงููุ ุงูุจุฑูุฌุฉุ ูุญุชู ุงูุฌูููุฌ. ูุจู ูุชุฑุฉุ ูุธููุง ูุฑุดุฉ ููุฃูู ุงูุณูุจุฑุงููุ ูุจูุนูู ููุงู ุฑุญูุงุช ููุฏุงููุฉ ูุดุฑูุงุช ุชูููููุฌูุฉ ุฒู Gaming lab.'''
    
    if 'ููุงุฆุฏ ุงูุนุถููุฉ' in processed:
        return '''ุงูุงูุถูุงู ุฅูู IEEE Computer Society ุจููุฏู ููุทุงูุจ ุงููุฑุต ุงูุชุงููุฉ:

- ูุตูู ููุฑุดุงุช ุนูู ูุฏูุฑุงุช ุชุฏุฑูุจูุฉ ูู ููุงุถูุน ูุชูุฏูุฉ ูุซู ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ ุงูุฃูู ุงูุณูุจุฑุงููุ ูุฅูุชุฑูุช ุงูุฃุดูุงุก.
- ุงููุตูู ุฅูู ููุชุจุฉ ุงูุฃุจุญุงุซ ุงููุจูุฑุฉ IEEEXplore ุงูู ูููุง ูููุฉ ูุจูุฑุฉ ููุชููุนุฉ ูู ุงูุงุจุญุงุซ ูุงููุชุจ ูุงููุฌูุงุช ุงูุนูููุฉ.
- ุงูุชูุงุนู ูุน ุทูุงุจ ู ูููุฏุณูู ูุฎุจุฑุงุก ูุจูุงุก ุดุจูุฉ ุนูุงูุงุช ูููุฉ.
- ุงููุดุงุฑูุฉ ูู ูุณุงุจูุงุช ุงูุจุฑูุฌุฉ ูุซู IEEEXtreme ุงู ุงู ูุณุงุจูุงุช ุงุฎุฑู ูููู ููุธููุง.
- ุชุนูู ุชูุธูู ูุนุงููุงุช ูุฅุฏุงุฑุฉ ูุดุงุฑูุน ูุงูุชุณุงุจ ุฎุจุฑุฉ ูู ุงูููุงุฏุฉ ูุงูุนูู ุถูู ูุฑู.
- ุงูุญุตูู ุนูู ุฎุตููุงุช ุนูู ุงูุชุณุฌูู ูู ูุคุชูุฑุงุช ููุนุงููุงุช ุนุงูููุฉ.
-  ูุฑุต ุชูููู ูููุญ ูููุดุงุฑูุน ุงูุจุญุซูุฉ ูุชุทููุฑ ุงูุฃููุงุฑ.
- ุชุนุฒูุฒ ุณูุฑุชู ุงูุฐุงุชูุฉ ูุฅุธูุงุฑ ุงูุชุฒุงูู ุจุงูุชุทููุฑ ูุงูุชุญุณูู ุงููุณุชูุฑ.'''

    if 'ููุฑู ุงูุฌุฏุฏ' in processed:
        return "https://forms.gle/mGzMz6z7ELtpR8Jf9"

    if 'ุชุบูุฑ ุงุณู ุงูุฌุงูุนุฉ' in processed:
        return "https://drive.google.com/file/d/1Sfy53uyo0FGpzmvcrtUcPOf8Nb7UMwDR/view?usp=sharing"


    if 'ููู md' in processed:
        return "https://drive.google.com/drive/folders/1g7awlB2ozsduY5cGDJpetKlqn0jLl3I3?usp=sharing"
    if 'ุงูุฃูุงูุฑ' in processed:
        return '''ุชุนุฑูู ุนู ุงูุจูุช 
ูุง ูู ุงูcs
ููุงุฆุฏ ุงูุนุถููุฉ 
ููุฏูููุงุช 
ููู md
ููุฑู ุงูุงูุถูุงูย
ููุฑูยุงูุฌุฏุฏ'''


    
# Handle messages
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_type: str = update.message.chat.type
    text: str = update.message.text

    print(f'User ({update.message.chat.id}) in {message_type}: "{text}"')

    if message_type == 'group':
        if BOT_USERNAME in text:
            new_text: str = text.replace(BOT_USERNAME, '').strip()
            response: str = handle_response(new_text)
        else:
            return
    else:
        response: str = handle_response(text)

    print('Bot:', response)
    await update.message.reply_text(response)

# Error handler
async def error(update: Update, context: ContextTypes.DEFAULT_TYPE):
    print(f'Update {update} caused error {context.error}')

if __name__ == '__main__':
    print("Starting bot....")
    app = Application.builder().token(TOKEN).build()

    # Command handlers
    app.add_handler(CommandHandler('start', start_command))
    app.add_handler(CommandHandler('help', help_command))

    # Message handler
    app.add_handler(MessageHandler(filters.TEXT, handle_message))

    # Error handler
    app.add_error_handler(error)

    print("Polling....")
    app.run_polling(poll_interval=3)

